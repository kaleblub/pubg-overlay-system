<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Scoreboard Overlay</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Inter font is a great default for a clean, modern look */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
    
    /* Overall styling for the body */
    body {
      background-color: transparent;
      color: #ffffff;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    
    /* Main container for the scoreboard */
    .scoreboard-container {
      width: 550px;
      max-width: 95%;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      background-color: #23272a;
    }
    
    /* Header row styling */
    .header {
      display: grid;
      grid-template-columns: 50px 1fr 60px 100px 70px;
      align-items: center;
      padding: 12px 20px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      background-color: #b5a420;
      border-bottom: 2px solid #23272a;
      color: #ffffff;
    }

    /* Styling for each team row */
    .team-row {
      display: grid;
      grid-template-columns: 50px 1fr 60px 100px 70px;
      align-items: stretch;
      padding: 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: background-color 0.3s ease;
      margin-top: 2px;
    }
    .team-row:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    .team-row:last-child {
      border-bottom: none;
    }
    /* Rank column in team rows */
    .team-row .rank {
      font-weight: bold;
      font-size: 1.1em;
      text-align: center;
      background-color: #b5a420; /* same as header Rank column */
      color: #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      width: 100%;
      border-radius: 0; /* optional: remove rounding to cover full height */
    }

    
    /* Styling for specific columns */
    .rank { font-weight: bold; font-size: 1.1em; text-align: center; }
    .team-info { display: flex; align-items: center; }
    .team-logo { width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; }
    .team-name { font-weight: 500; font-size: 0.95em; }
    .elim-count, .total-points { text-align: center; font-weight: bold; }
    
    /* Player status bars container */
    .status-bars {
      display: flex;
      gap: 4px;
      justify-content: center;
      align-items: center;
    }
    
    /* Player status bar and health bar styling */
    .status-bar {
      width: 20px;
      height: 20px;
      border-radius: 5px;
      background-color: #4a4d52;
      border: 1px solid #3d4045;
      position: relative;
      overflow: hidden;
    }
    .status-bar-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #2ecc71; /* Green for health */
      transition: height 0.3s ease; /* Smooth transition for health updates */
    }
    
    /* Specific styles for low health */
    .status-bar-fill.low-health {
      background-color: #e74c3c; /* Red for low health */
    }
    
    /* Styling for eliminated players */
    .status-x {
      width: 20px;
      height: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: #e74c3c;
      font-size: 1.2em;
    }
    
    /* Styling for an eliminated team */
    .team-eliminated {
      opacity: 0.5;
      background-color: rgba(255, 255, 255, 0.02);
    }

  </style>
</head>
<body class="bg-gray-800 text-white p-4">

  <div class="scoreboard-container" id="scoreboard">
    <div class="header">
      <div>Rank</div>
      <div>Team</div>
      <div>Kills</div>
      <div>Status</div>
      <div>Points</div>
    </div>
    <div id="teams-list">
      <!-- Team rows will be injected here by the script -->
    </div>
  </div>

  <script>
    // The URL for the live JSON data
    const jsonUrl = "../live_scoreboard.json";

    // Simple exponential backoff for fetching data to handle intermittent network issues
    const retryFetch = async (url, retries = 5, delay = 1000) => {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url, { cache: "no-store" });
          if (response.ok) {
            return response;
          }
        } catch (error) {
          console.warn(`Fetch attempt ${i + 1} failed. Retrying in ${delay}ms...`, error);
          await new Promise(res => setTimeout(res, delay));
          delay *= 2; // Exponential backoff
        }
      }
      throw new Error('Failed to fetch data after multiple retries.');
    };

    /**
     * Updates the scoreboard UI with new data from the JSON file.
     * @param {Array} standings - An array of team standings.
     * @param {Object} teams - A dictionary of team information by teamId.
     * @param {Object} players - A dictionary of player information by playerId.
     */
    const updateScoreboard = (standings, teams, players) => {
      // --- DEBUGGING: Log the data being passed to the function ---
      console.log("updateScoreboard called with data:");
      console.log("Standings:", standings);
      console.log("Teams:", teams);
      console.log("Players:", players);
      // --- END DEBUGGING ---

      const teamsList = document.getElementById("teams-list");
      teamsList.innerHTML = ""; // Clear previous data

      // Sort standings by rank
      standings.sort((a, b) => a.rank - b.rank);

      standings.forEach(standing => {
        // --- DEBUGGING: Log the current standing object in the loop ---
        console.log("Processing standing:", standing);
        // --- END DEBUGGING ---

        const teamInfo = teams[standing.teamId];
        if (!teamInfo) {
          console.warn(`Team info not found for teamId: ${standing.teamId}`);
          return;
        }

        // Filter players for the current team
        let teamPlayers = Object.values(players).filter(p => p.teamId === standing.teamId);

        // Sort: alive first, then by kills
        teamPlayers.sort((a, b) => {
          if (a.live.isAlive && !b.live.isAlive) return -1;
          if (!a.live.isAlive && b.live.isAlive) return 1;
          return b.stats.kills - a.stats.kills;
        });

        // Only take the first 4
        teamPlayers = teamPlayers.slice(0, 4);

        // --- DEBUGGING: Check if teamPlayers array is populated ---
        console.log(`Found ${teamPlayers.length} players for team ${teamInfo.name}`);
        // --- END DEBUGGING ---

        // Generate the HTML for the player status bars
        const statusBarsHtml = teamPlayers.map(player => {
          // Check if the player is alive and has live data
          if (player.live && typeof player.live.isAlive !== 'undefined') {
            if (player.live.isAlive) {
              const healthPercentage = (player.live.health / player.live.healthMax) * 100;
              const healthClass = healthPercentage <= 25 ? 'low-health' : '';
              return `
                <div class="status-bar" title="${player.name}: ${player.live.health} HP">
                  <div class="status-bar-fill ${healthClass}" style="height: ${healthPercentage}%;"></div>
                </div>
              `;
            } else {
              // Player is eliminated
              return `<div class="status-x">X</div>`;
            }
          }
          // If player.live or player.live.isAlive is missing, return an X to indicate a non-live state
          return `<div class="status-x">X</div>`;
        }).join("");

        // Check if all players on the team are eliminated
        const isEliminated = teamPlayers.length > 0 && teamPlayers.every(player => !player.live.isAlive);

        const row = document.createElement("div");
        row.className = "team-row";
        if (isEliminated) row.classList.add("team-eliminated");

        row.innerHTML = `
          <div class="rank">${standing.rank}</div>
          <div class="team-info">
            <img src="${teamInfo.logo || 'https://placehold.co/35x35/ffffff/000000?text=L'}" class="team-logo">
            <span class="team-name">${teamInfo.name}</span>
          </div>
          <div class="elim-count">${standing.kills}</div>
          <div class="status-bars">${statusBarsHtml}</div>
          <div class="total-points">${standing.points}</div>
        `;
        teamsList.appendChild(row);
      });
    };

    const fetchData = async () => {
      try {
        const res = await retryFetch(jsonUrl);
        const data = await res.json();

        if (data.phase && data.phase.standings && data.match && data.live) {
          updateScoreboard(
            data.phase.standings,
            data.match.teams,      // live team data
            data.match.players     // live player data
          );
        } else {
          console.error("JSON missing expected keys.");
        }
      } catch (error) {
        console.error("Failed to fetch or parse JSON:", error);
      }
    };


    // Fetch data immediately on load and then every 2 seconds
    document.addEventListener("DOMContentLoaded", () => {
      fetchData();
      setInterval(fetchData, 2000);
    });
  </script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Scoreboard Overlay</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Inter font is a great default for a clean, modern look */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
   
    /* Overall styling for the body */
    body {
      background-color: transparent;
      color: #ffffff;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
   
    /* Main container for the scoreboard */
    .scoreboard-container {
      width: 600px;
      max-width: 95%;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      background-color: #23272a;
    }
   
    /* Header row styling */
    .header {
      display: grid;
      grid-template-columns: 50px 1fr 80px 120px 80px;
      align-items: center;
      padding: 12px 0px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      background-color: #b5a420;
      border-bottom: 2px solid #23272a;
      color: #ffffff;
    }
    
    .header > div:first-child {
      text-align: left;
      padding-left: 0;
    }
    
    .header .kills-cell,
    .header .status-cell,
    .header .points-cell {
      text-align: center;
    }

    /* Team row styling */
    .team-row {
      display: grid;
      grid-template-columns: 50px 1fr 80px 120px 80px;
      align-items: stretch;
      padding: 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: background-color 0.3s ease;
      margin-top: 0px;
    }
    .team-row:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    .team-row:last-child {
      border-bottom: none;
    }

    /* Column alignment */
    .rank-cell, .points-cell, .kills-cell, .status-cell {
      text-align: center;
    }
    
    .rank-cell {
      font-weight: bold;
      font-size: 1.1em;
      text-align: center;
      background-color: #b5a420;
      color: #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      width: 100%;
    }
    
    .team-name-cell {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 5px;
    }
    .team-name-cell img {
      width: 35px;
      height: 35px;
      border-radius: 50%;
    }
    
    .kills-cell, .points-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 5px 5px;
      font-weight: bold;
      padding-left: 10px;
    }

    .points-cell {
      padding-right: 20px;
    }
    
    .player-status-cell {
      display: flex;
      gap: 4px;
      justify-content: center;
      align-items: center;
      padding: 5px 5px;
      padding-left: 10px;
    }
    
    /* Player status bar and health bar styling */
    .status-bar {
      width: 10px;
      height: 10px;
      border-radius: 5px;
      background-color: #4a4d52;
      border: 1px solid #3d4045;
      position: relative;
      overflow: hidden;
    }
    .status-bar-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #2ecc71; /* Green for health */
      transition: height 0.3s ease;
    }
    
    /* Specific styles for low health */
    .status-bar-fill.low-health {
      background-color: #e74c3c;
    }
    
    /* Styling for eliminated players */
    .status-x {
      width: 20px;
      height: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: #e74c3c;
      font-size: 1em;
    }
    
    .status-text {
      text-align: center;
      padding: 10px;
      color: #999;
    }
    
    .missing-text {
        text-align: center;
        width: 100%;
        color: #e74c3c;
        font-weight: bold;
        white-space: nowrap;
        font-size: 0.9em;
    }
  </style>
</head>
<body>

<div class="scoreboard-container">
  <div class="header">
    <div class="rank-cell">#</div>
    <div>Team</div>
    <div class="kills-cell">Kills</div>
    <div class="status-cell">Status</div>
    <div class="points-cell">Points</div>
  </div>

  <div id="teams-list">
    <div class="status-text">Loading scoreboard...</div>
  </div>

</div>

<script>
    const fetchData = async () => {
      try {
        const response = await fetch("http://localhost:5000/live_scoreboard.json");
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        const updateScoreboard = (standings, currentMatchTeams, currentPlayers, lastMatchTeams, matchStatus) => {
            const teamsList = document.getElementById('teams-list');
            teamsList.innerHTML = '';
            
            if (standings.length === 0) {
                teamsList.innerHTML = `<div class="status-text">No teams data available</div>`;
                return;
            }
            
            // Loop through the standings data from the JSON
            standings.forEach((team) => {
                const teamRow = document.createElement('div');
                teamRow.className = 'team-row';

                // Rank
                const rankCell = document.createElement('div');
                rankCell.className = 'rank-cell';
                rankCell.textContent = team.rank;
                teamRow.appendChild(rankCell);

                // Find the team info by matching teamId
                let teamInfo = null;
                // Prioritize live match data first if available
                if (currentMatchTeams[team.teamId]) {
                    teamInfo = currentMatchTeams[team.teamId];
                } else if (lastMatchTeams && lastMatchTeams[team.teamId]) {
                    // Fall back to the last completed match data if current is not available
                    teamInfo = lastMatchTeams[team.teamId];
                }

                // Team Name with Logo
                const teamNameCell = document.createElement('div');
                teamNameCell.className = 'team-name-cell';

                // Add team logo if available from either standing or teamInfo
                const teamLogo = teamInfo?.logo || team.teamLogo;
                let teamAbbreviation = null;

                if (teamLogo) {
                  teamNameCell.innerHTML += `<img src="${teamLogo}" onerror="this.src='http://localhost:5000/assets/default-team-logo.jpg'" alt="${team.teamName} Logo">`;

                  const logoFilename = teamLogo.split('/').pop(); // e.g. "hv.png"
                  if (logoFilename) {
                    teamAbbreviation = logoFilename.split('.')[0]; // "hv"
                  }
                }

                teamNameCell.innerHTML += `<span>${(teamAbbreviation || team.teamName).toUpperCase()}</span>`;

                teamRow.appendChild(teamNameCell);
                
                // KILLS - Prioritize live kills, then last match kills, then phase standings
                let killsToDisplay = null;

                if (currentMatchTeams[team.teamId]?.teamStats?.totalKills !== undefined) {
                  killsToDisplay = currentMatchTeams[team.teamId].teamStats.totalKills;
                } else if (lastMatchTeams?.[team.teamId]?.teamStats?.totalKills !== undefined) {
                  killsToDisplay = lastMatchTeams[team.teamId].teamStats.totalKills;
                } else if (team.kills !== undefined) {
                  killsToDisplay = team.kills; // standings fallback
                }


                const killsCell = document.createElement('div');
                killsCell.className = 'kills-cell';
                killsCell.textContent = killsToDisplay;
                teamRow.appendChild(killsCell);
                
                // STATUS COLUMN - Player health bars or "MISS"
                const statusCell = document.createElement('div');
                statusCell.className = 'player-status-cell';

                // Check if the team is missing
                if (teamInfo && teamInfo.missing) {
                    const missingText = document.createElement('div');
                    missingText.className = 'missing-text';
                    missingText.textContent = 'M I S S';
                    statusCell.appendChild(missingText);
                } else {
                    // Display player health bars based on status
                    let playersToUse = currentPlayers;
                    // Fallback to previous match player data if current is empty
                    if ((!currentPlayers || Object.keys(currentPlayers).length === 0) && lastMatchTeams) {
                        playersToUse = lastMatchTeams[team.teamId]?.players || [];
                    }

                    if (teamInfo && teamInfo.players && teamInfo.players.length > 0) {
                        teamInfo.players.forEach(playerId => {
                            // Find player info from the current or last match data
                            const playerInfo = playersToUse[playerId];
                            
                            if (playerInfo && playerInfo.live && playerInfo.live.isAlive && matchStatus === 'live') {
                                // Create health bar for alive player during live match
                                const statusBar = document.createElement('div');
                                statusBar.className = 'status-bar';
                                statusBar.title = `${playerInfo.name}: ${playerInfo.live.health} HP`;
                                
                                const statusBarFill = document.createElement('div');
                                statusBarFill.className = 'status-bar-fill';
                                
                                const healthPercentage = (playerInfo.live.health / playerInfo.live.healthMax) * 100;
                                if (healthPercentage <= 25) {
                                    statusBarFill.classList.add('low-health');
                                }
                                statusBarFill.style.height = `${healthPercentage}%`;
                                
                                statusBar.appendChild(statusBarFill);
                                statusCell.appendChild(statusBar);
                            } else {
                                // Create X for dead/unknown player or when match is idle
                                const statusX = document.createElement('div');
                                statusX.className = 'status-x';
                                statusX.textContent = 'X';
                                statusCell.appendChild(statusX);
                            }
                        });
                    } else {
                        // Add unknown status indicators if no player data
                        for (let i = 0; i < 4; i++) {
                            const statusX = document.createElement('div');
                            statusX.className = 'status-x';
                            statusX.textContent = 'X';
                            statusCell.appendChild(statusX);
                        }
                    }
                }
                teamRow.appendChild(statusCell);

                // POINTS - Use phase total points when idle; add current match kills when live
                const totalPoints = team.points + (teamInfo?.kills || 0);
                
                const pointsCell = document.createElement('div');
                pointsCell.className = 'points-cell';
                pointsCell.textContent = totalPoints;
                teamRow.appendChild(pointsCell);
                
                teamsList.appendChild(teamRow);
            });
        };

        const matchStatus = data.match?.status || 'idle';
        let currentMatchTeams = data.match?.teams || {};
        let currentPlayers = data.match?.players || {};
        let lastMatchTeams = null;
        
        // Find the last completed match to use its team data
        if (data.matches && data.matches.length > 0) {
            const lastMatch = data.matches[data.matches.length - 1];
            if (lastMatch && lastMatch.teams) {
                lastMatchTeams = lastMatch.teams;
            }
        }
        
        if (data.phase?.standings) {
          updateScoreboard(
            data.phase.standings,
            currentMatchTeams,
            currentPlayers,
            lastMatchTeams,
            matchStatus
          );
        } else {
          document.getElementById("teams-list").innerHTML = `<div class="status-text">No standings data available</div>`;
        }
      } catch (error) {
        console.error("Failed to fetch or parse JSON:", error);
        document.getElementById("teams-list").innerHTML = `<div class="status-text" style="color:#ff6b6b;">Error loading data</div>`;
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      fetchData();
      setInterval(fetchData, 2000);
    });
</script>

</body>
</html>

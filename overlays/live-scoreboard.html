<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Scoreboard Overlay</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Inter font is a great default for a clean, modern look */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
   
    /* Overall styling for the body */
    body {
      background-color: transparent;
      color: #ffffff;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
   
    /* Main container for the scoreboard */
    .scoreboard-container {
      width: 600px;
      max-width: 95%;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      background-color: #23272a;
    }
   
    /* Header row styling */
    .header {
      display: grid;
      grid-template-columns: 50px 1fr 80px 120px 80px;
      align-items: center;
      padding: 12px 0px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      background-color: #b5a420;
      border-bottom: 2px solid #23272a;
      color: #ffffff;
    }
    
    .header > div:first-child {
      text-align: left;
      padding-left: 0;
    }
    
    .header .kills-cell,
    .header .status-cell,
    .header .points-cell {
      text-align: center;
    }

    /* Team row styling */
    .team-row {
      display: grid;
      grid-template-columns: 50px 1fr 80px 120px 80px;
      align-items: stretch;
      padding: 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: background-color 0.3s ease;
      margin-top: 0px;
    }
    .team-row:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    .team-row:last-child {
      border-bottom: none;
    }

    /* Column alignment */
    .rank-cell, .points-cell, .kills-cell, .status-cell {
      text-align: center;
    }
    
    .rank-cell {
      font-weight: bold;
      font-size: 1.1em;
      text-align: center;
      background-color: #b5a420;
      color: #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      width: 100%;
    }
    
    .team-name-cell {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 5px;
      background-color: #5AB4D6;
    }
    .team-name-cell img {
      width: 35px;
      height: 35px;
      border-radius: 50%;
    }
    
    .kills-cell, .points-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 5px 5px;
      font-weight: bold;
      padding-left: 10px;
    }

    .points-cell {
      padding-right: 20px;
    }
    
    .player-status-cell {
      display: flex;
      gap: 4px;
      justify-content: center;
      align-items: center;
      padding: 5px 5px;
      padding-left: 10px;
    }
    
    /* Player status bar and health bar styling */
    .status-bar {
      width: 10px;
      height: 20px;
      background-color: #ffffff;
      border: 1px solid #3d4045;
      position: relative;
      overflow: hidden;
    }
    .status-bar-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #1e90ff;
      transition: height 0.3s ease;
    }
    
    /* Specific styles for low health */
    .status-bar-fill.low-health {
      background-color: #e74c3c;
    }
    
    /* Styling for eliminated players */
    .status-x {
      width: 20px;
      height: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: #e74c3c;
      font-size: 1em;
    }
    
    .status-text {
      text-align: center;
      padding: 10px;
      color: #999;
    }
    
    .missing-text {
        text-align: center;
        width: 100%;
        color: #e74c3c;
        font-weight: bold;
        white-space: nowrap;
        font-size: 0.9em;
    }
  </style>
</head>
<body>

<div class="scoreboard-container">
  <div class="header">
    <div class="rank-cell">#</div>
    <div>Team</div>
    <div class="kills-cell">Kills</div>
    <div class="status-cell">Status</div>
    <div class="points-cell">Points</div>
  </div>

  <div id="teams-list">
    <div class="status-text">Loading scoreboard...</div>
  </div>

</div>

<script>
    let lastData = null; // Cache for last successful data
    const jsonUrl = "http://localhost:5000/live_scoreboard.json";
    const defaultLogo = "http://localhost:5000/assets/default-team-logo.jpg";
    const retryDelay = 5000; // Retry every 5s on failure

    const fetchData = async () => {
      try {
        const response = await fetch(jsonUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        lastData = data; // Cache successful data
        
        const updateScoreboard = (standings, currentMatchTeams, currentPlayers, lastMatchTeams, matchStatus, isCached = false) => {
            const teamsList = document.getElementById('teams-list');
            teamsList.innerHTML = '';
            
            if (standings.length === 0) {
                teamsList.innerHTML = `<div class="status-text">No teams data available${isCached ? ' (using cached data)' : ''}</div>`;
                return;
            }
            
            // Create mapping of team names to numeric IDs
            const teamNameToId = {};
            if (matchStatus === 'live' && currentMatchTeams) {
                Object.values(currentMatchTeams).forEach(team => {
                    teamNameToId[team.name] = team.id;
                });
            } else if (lastMatchTeams) {
                Object.values(lastMatchTeams).forEach(team => {
                    teamNameToId[team.name] = team.id;
                });
            }
            
            // Sort standings: active teams by points then kills, missing teams at the bottom
            standings.sort((a, b) => {
                if (a.teamId === 'MISS' && b.teamId !== 'MISS') return 1;
                if (b.teamId === 'MISS' && a.teamId !== 'MISS') return -1;
                if (a.teamId === 'MISS' && b.teamId === 'MISS') return 0;
                return (b.points !== a.points) ? (b.points - a.points) : (b.kills - a.kills);
            });

            // Cap at 25 teams
            standings = standings.slice(0, 25);
            
            // Loop through the standings data from the JSON
            standings.forEach((team, index) => {
                const teamRow = document.createElement('div');
                teamRow.className = 'team-row';

                // Rank
                const rankCell = document.createElement('div');
                rankCell.className = 'rank-cell';
                rankCell.textContent = team.teamId === 'MISS' ? 'MISS' : index + 1;
                teamRow.appendChild(rankCell);

                // Find the team info by matching teamId to numeric ID
                let teamInfo = null;
                const numericId = teamNameToId[team.teamId]; // Map "IVS ESPORTS" to "13"
                if (matchStatus === 'live' && numericId && currentMatchTeams[numericId]) {
                    teamInfo = currentMatchTeams[numericId];
                } else if (numericId && lastMatchTeams && lastMatchTeams[numericId]) {
                    teamInfo = lastMatchTeams[numericId];
                }

                // Debug logging (optional - can be removed once confirmed working)
                console.log({
                    teamId: team.teamId,
                    teamName: team.teamName,
                    phaseKills: team.kills,
                    numericId: numericId,
                    teamInfo: teamInfo,
                    currentMatchTeams: numericId ? currentMatchTeams[numericId] : null,
                    lastMatchTeams: numericId && lastMatchTeams ? lastMatchTeams[numericId] : null,
                    matchStatus: matchStatus,
                    selectedKills: teamInfo?.kills ?? team.kills ?? 0
                });

                // Team Name with Logo
                const teamNameCell = document.createElement('div');
                teamNameCell.className = 'team-name-cell';

                // Add team logo if available from either standing or teamInfo
                const teamLogo = teamInfo?.logo || team.teamLogo || defaultLogo;
                let teamAbbreviation = team.teamName;

                if (teamLogo && teamLogo !== defaultLogo) {
                  teamNameCell.innerHTML += `<img src="${teamLogo}" onerror="this.src='${defaultLogo}'" alt="${team.teamName} Logo">`;
                  const logoFilename = teamLogo.split('/').pop();
                  if (logoFilename) {
                    teamAbbreviation = logoFilename.split('.')[0].toUpperCase();
                  }
                } else {
                  teamNameCell.innerHTML += `<img src="${defaultLogo}" alt="${team.teamName} Logo">`;
                }

                teamNameCell.innerHTML += `<span>${teamAbbreviation}</span>`;
                teamRow.appendChild(teamNameCell);
                
                // KILLS - Prioritize match-specific kills
                let killsToDisplay = teamInfo?.kills ?? team.kills ?? 0;

                const killsCell = document.createElement('div');
                killsCell.className = 'kills-cell';
                killsCell.textContent = killsToDisplay;
                teamRow.appendChild(killsCell);
                
                // STATUS COLUMN - Player health bars or "MISS"
                const statusCell = document.createElement('div');
                statusCell.className = 'player-status-cell';

                // Check if the team is missing
                if (teamInfo && teamInfo.missing) {
                    const missingText = document.createElement('div');
                    missingText.className = 'missing-text';
                    missingText.textContent = 'M I S S';
                    statusCell.appendChild(missingText);
                } else {
                    // Display player health bars based on status
                    let playersToUse = currentPlayers;
                    if ((!currentPlayers || Object.keys(currentPlayers).length === 0) && lastMatchTeams) {
                        playersToUse = lastMatchTeams[numericId]?.players || [];
                    }

                    if (teamInfo && teamInfo.players && teamInfo.players.length > 0) {
                        teamInfo.players.forEach(playerId => {
                            const playerInfo = playersToUse[playerId];
                            
                            if (playerInfo && playerInfo.live && playerInfo.live.isAlive && matchStatus === 'live') {
                                const statusBar = document.createElement('div');
                                statusBar.className = 'status-bar';
                                statusBar.title = `${playerInfo.name}: ${playerInfo.live.health} HP`;
                                
                                const statusBarFill = document.createElement('div');
                                statusBarFill.className = 'status-bar-fill';
                                
                                const healthPercentage = (playerInfo.live.health / playerInfo.live.healthMax) * 100;
                                if (healthPercentage <= 25) {
                                    statusBarFill.className += ' low-health';
                                }
                                statusBarFill.style.height = `${healthPercentage}%`;
                                
                                statusBar.appendChild(statusBarFill);
                                statusCell.appendChild(statusBar);
                            } else {
                                const statusX = document.createElement('div');
                                statusX.className = 'status-x';
                                statusX.textContent = 'X';
                                statusCell.appendChild(statusX);
                            }
                        });
                    } else {
                        for (let i = 0; i < 4; i++) {
                            const statusX = document.createElement('div');
                            statusX.className = 'status-x';
                            statusX.textContent = 'X';
                            statusCell.appendChild(statusX);
                        }
                    }
                }
                teamRow.appendChild(statusCell);

                // POINTS - Use phase total points
                const totalPoints = team.points || 0;
                
                const pointsCell = document.createElement('div');
                pointsCell.className = 'points-cell';
                pointsCell.textContent = totalPoints;
                teamRow.appendChild(pointsCell);
                
                teamsList.appendChild(teamRow);
            });
        };

        const matchStatus = data.match_state?.status || 'idle';
        let currentMatchTeams = data.current_match?.teams || {};
        let currentPlayers = data.current_match?.players || {};
        let lastMatchTeams = null;
        
        if (data.matches && data.matches.length > 0) {
            const lastMatch = data.matches[data.matches.length - 1];
            if (lastMatch && lastMatch.teams) {
                lastMatchTeams = lastMatch.teams;
            }
        }
        
        if (data.phase?.standings) {
          updateScoreboard(
            data.phase.standings,
            currentMatchTeams,
            currentPlayers,
            lastMatchTeams,
            matchStatus
          );
        } else {
          document.getElementById("teams-list").innerHTML = `<div class="status-text">No standings data available${isCached ? ' (using cached data)' : ''}</div>`;
        }
      } catch (error) {
        console.error("Failed to fetch or parse JSON:", error);
        if (lastData) {
            const matchStatus = lastData.match_state?.status || 'idle';
            let currentMatchTeams = lastData.current_match?.teams || {};
            let currentPlayers = lastData.current_match?.players || {};
            let lastMatchTeams = null;
            if (lastData.matches && lastData.matches.length > 0) {
                const lastMatch = lastData.matches[lastData.matches.length - 1];
                if (lastMatch && lastMatch.teams) {
                    lastMatchTeams = lastMatch.teams;
                }
            }
            if (lastData.phase?.standings) {
                updateScoreboard(
                    lastData.phase.standings,
                    currentMatchTeams,
                    currentPlayers,
                    lastMatchTeams,
                    matchStatus,
                    true
                );
            } else {
                document.getElementById("teams-list").innerHTML = `<div class="status-text">No standings data available (using cached data)</div>`;
            }
        } else {
            document.getElementById("teams-list").innerHTML = `<div class="status-text">Waiting for server data...</div>`;
        }
        setTimeout(fetchData, retryDelay);
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      fetchData();
      setInterval(fetchData, 5000);
    });
</script>

</body>
</html>
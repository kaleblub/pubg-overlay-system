<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUBG Team Elimination Overlay</title>
    <link rel="stylesheet" href="./styles.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        
        body {
            background-color: transparent; 
            font-family: 'Roboto', sans-serif;
            color: white;
            margin: 0;
            padding: 0;
            font-weight: bold;
        }

        #elim-popup {
            display: none; /* No !important to allow JS override */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            opacity: 1; /* Ensure visible */
            flex-direction: row;
            align-items: stretch;
            min-width: 400px; /* Minimum width */
            width: auto; /* Grow with content */
            max-width: 800px; /* Prevent excessive width */
            min-height: 120px; /* Minimum height */
            height: auto; /* Grow with content */
            padding: 10px; /* Add padding for content */
        }

        .column {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .left-column {
            width: 100px; /* Fixed width for logo */
            position: relative;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            background-color: var(--main-color, #ffffff);
        }

        .center-column {
            flex: 1; /* Grow to fit team name */
            text-align: center;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            background-color: var(--accent-color, #333333);
            min-width: 150px; /* Ensure enough space for text */
        }

        .right-column {
            width: 100px; /* Fixed width for kills */
        }

        #elim-placement {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 1.2em;
            font-weight: 700;
            color: var(--main-color, #ffffff);
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 8px;
            border-radius: 5px;
        }

        #elim-logo {
            width: 100%;
            height: 80px; /* Fixed height for logo */
            object-fit: contain;
            margin-top: 20px;
        }

        #elim-name {
            font-size: 1.8em; /* Adjusted for wrapping */
            font-weight: 700;
            text-transform: uppercase;
            color: rgba(0, 0, 0, 0.8);
            margin-bottom: 5px;
            white-space: normal; /* Allow wrapping */
            word-wrap: break-word; /* Ensure long words wrap */
            max-width: 100%;
            line-height: 1.2; /* Improve readability */
        }

        .elim-status {
            font-size: 1.8em; /* Match team name size */
            color: var(--main-color, #ffffff);
            text-transform: uppercase;
            margin-top: 5px;
        }

        #elim-kills {
            font-size: 3.5em; /* Slightly smaller for balance */
            font-weight: 700;
            color: var(--main-color, #ffffff);
            margin-bottom: 5px;
        }

        .kills-label {
            font-size: 1.8em; /* Match other text */
            text-transform: uppercase;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -40%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translate(-50%, -50%); }
            to { opacity: 0; transform: translate(-50%, -40%); }
        }
    </style>
</head>
<body>

    <div id="elim-popup">
        <div class="column left-column">
            <div id="elim-placement"></div>
            <img id="elim-logo" src="" alt="Team Logo">
        </div>
        <div class="column center-column">
            <div id="elim-name"></div>
            <div class="elim-status">ELIMINATED</div>
        </div>
        <div class="column right-column">
            <div id="elim-kills"></div>
            <div class="kills-label">KILLS</div>
        </div>
    </div>
    
<script>
const API_URL = '/api/live_data';
const defaultLogo = "/assets/default-team-logo.jpg";
let prevElimOrder = [];
let prevMatchId = null;
const POPUP_DURATION = 5000; // 5 seconds

function getOrdinal(n) {
    const s = ["th", "st", "nd", "rd"];
    const v = n % 100;
    return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

async function fetchData() {
    try {
        console.log('Fetching data from:', API_URL);
        const response = await fetch(API_URL);
        console.log('Fetch response status:', response.status);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        console.log('Received data:', JSON.stringify(data, null, 2));

        const matchStatus = data.match_state?.status || 'idle';
        const currentMatchId = data.current_match?.id || null;
        const currentElimOrder = data.current_match?.eliminationOrder || [];
        const teams = data.current_match?.teams || {};

        console.log('Match Status:', matchStatus);
        console.log('Current Match ID:', currentMatchId);
        console.log('Current Elimination Order:', currentElimOrder);
        console.log('Teams:', teams);
        console.log('Previous Elimination Order:', prevElimOrder);

        if (currentMatchId !== prevMatchId) {
            console.log(`Match ID changed from ${prevMatchId} to ${currentMatchId}. Resetting prevElimOrder.`);
            prevElimOrder = [];
            prevMatchId = currentMatchId;
        }

        if (matchStatus === 'live' && currentMatchId && Object.keys(teams).length > 0) {
            const findTeamByName = (name) => {
                const team = Object.values(teams).find(team => team.name.trim().toLowerCase() === name.trim().toLowerCase());
                console.log(`Looking up team: ${name}, Found:`, team);
                return team;
            };

            const eliminationsToProcess = currentElimOrder.slice(prevElimOrder.length);
            console.log('Eliminations to process:', eliminationsToProcess);

            if (eliminationsToProcess.length > 0) {
                eliminationsToProcess.forEach((teamName, index) => {
                    console.log('Processing elimination for team:', teamName);
                    const team = findTeamByName(teamName);

                    if (team) {
                        const totalTeams = Object.keys(teams).length;
                        const elimIndex = currentElimOrder.indexOf(teamName);
                        const placement = totalTeams - elimIndex;
                        console.log(`Queuing popup for team: ${team.name}, Placement: ${placement}, Kills: ${team.kills || 0}`);

                        showPopup({
                            name: team.name,
                            logo: team.logo || defaultLogo,
                            placement: placement,
                            kills: team.kills || 0
                        });
                    } else {
                        console.warn(`Team ${teamName} not found in teams object.`);
                    }
                });
            } else {
                console.log('No new eliminations to process.');
            }

            prevElimOrder = [...currentElimOrder];
            console.log('Updated prevElimOrder:', prevElimOrder);
        } else {
            console.log('Not processing: Match not live or no valid data.', {
                isLive: matchStatus === 'live',
                hasMatchId: !!currentMatchId,
                hasTeams: Object.keys(teams).length > 0
            });
        }
    } catch (error) {
        console.error('Error fetching data:', error);
        setTimeout(fetchData, 1000);
    }
}

function showPopup(teamData) {
    console.log('Showing popup with data:', teamData);
    const popup = document.getElementById('elim-popup');
    const logo = document.getElementById('elim-logo');
    const name = document.getElementById('elim-name');
    const place = document.getElementById('elim-placement');
    const kills = document.getElementById('elim-kills');

    logo.src = teamData.logo;
    logo.onerror = () => { 
        console.warn(`Failed to load logo: ${teamData.logo}, using default: ${defaultLogo}`);
        logo.src = defaultLogo; 
    };
    name.textContent = teamData.name;
    place.textContent = getOrdinal(teamData.placement);
    kills.textContent = teamData.kills;

    popup.style.display = 'flex';
    popup.style.opacity = '1';
    popup.style.animation = 'fadeIn 0.5s ease-in-out';
    console.log('Popup displayed for team:', teamData.name, 'Styles:', {
        display: popup.style.display,
        opacity: popup.style.opacity,
        zIndex: popup.style.zIndex
    });

    setTimeout(() => {
        console.log('Hiding popup for team:', teamData.name);
        popup.style.animation = 'fadeOut 0.5s ease-in-out';
        setTimeout(() => {
            popup.style.display = 'none';
            popup.style.opacity = '0';
            console.log('Popup hidden');
        }, 500);
    }, POPUP_DURATION);
}

document.addEventListener('DOMContentLoaded', () => {
    console.log('Overlay initialized, starting data fetch...');
    const popup = document.getElementById('elim-popup');
    console.log('Initial popup display style:', popup.style.display);
    fetchData();
    setInterval(fetchData, 1000);
});
</script>

</body>
</html>